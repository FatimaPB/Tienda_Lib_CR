<div class="container" *ngIf="perfil">
  <div class="profile-header">
    <div class="header-content">
      <div class="avatar">{{ perfil.nombre?.charAt(0) || 'U' }}</div>
      <div class="user-info">
        <h1>{{ perfil.nombre }}</h1>
        <p>Gestiona tu informaci√≥n personal</p>
      </div>
    </div>
  </div>

  <div class="main-grid">
    <!-- üßæ FORMULARIO PERFIL -->
    <div class="profile-form">
      <div class="form-header">
        <h2>Informaci√≥n Personal</h2>
      </div>

      <!-- Nombre -->
      <div class="form-group">
        <label for="nombre">Nombre Completo</label>
        <div class="input-group">
          <mat-icon class="input-icon">person</mat-icon>
          <input
            type="text"
            id="nombre"
            [(ngModel)]="perfil.nombre"
            [readonly]="!showForm"
            name="nombre"
            (ngModelChange)="onInputChange()"
          />
        </div>
      </div>

      <!-- Email -->
      <div class="form-group">
        <label for="email">Correo Electr√≥nico</label>
        <div class="input-group" style="position: relative;">
          <mat-icon class="input-icon-left">mail</mat-icon>
          <input
            type="email"
            id="email"
            [(ngModel)]="perfil.correo"
            readonly
            name="email"
            class="input-with-icons locked-input"
          />
          <mat-icon class="input-icon-right">lock</mat-icon>
        </div>
      </div>

      <!-- Tel√©fono -->
      <div class="form-group">
        <label for="telefono">Tel√©fono</label>
        <div class="input-group">
          <mat-icon class="input-icon">phone</mat-icon>
          <input
            type="tel"
            id="telefono"
            [(ngModel)]="perfil.telefono"
            [readonly]="!showForm"
            name="telefono"
            maxlength="10"
            (keypress)="preventLetters($event)"
            (ngModelChange)="onInputChange()"
          />
        </div>
      </div>

      <button class="btn"
              [ngClass]="showForm ? 'btn-success' : 'btn-primary'"
              (click)="toggleEditarGuardar()"
              [disabled]="showForm && (!isFormChanged() || !isValidPhoneNumber())">
        <mat-icon>{{ showForm ? 'save' : 'edit' }}</mat-icon>
        {{ showForm ? 'Guardar Cambios' : 'Editar Perfil' }}
      </button>

      <button *ngIf="showForm" class="btn btn-secondary" (click)="cancelarEdicion()">
        <mat-icon>cancel</mat-icon> Cancelar
      </button>
    </div>

    <!-- üì¶ SIDEBAR DERECHA -->
    <div class="sidebar">
      <!-- SEGURIDAD -->
      <div class="card">
        <div class="card-header">
          <mat-icon class="icon">security</mat-icon>
          <h3>Seguridad</h3>
        </div>

        <div class="security-option">
          <div class="security-content">
            <div class="security-info">
              <h4>Autenticaci√≥n de Dos Factores</h4>
              <p>Agrega una capa extra de seguridad</p>
            </div>
            <div
            class="toggle-switch"
            [class.active]="perfil.mfa_activado == 1"
            (click)="perfil.mfa_activado == 1 ? desactivarMFA() : activarMFA()">
            </div>
          </div>
        </div>

        <!-- Mostrar estado -->
        <div style="text-align: center;">
          <span [ngClass]="perfil.mfa_activado == 1 ? 'status-badge active' : 'status-badge inactive'">
            {{ perfil.mfa_activado == 1 ? 'Activado' : 'Desactivado' }}
          </span>
        </div>

        <!-- Mostrar QR al activar MFA -->
        <div *ngIf="mfaQRCode" class="qr-section">
          <h4>Escanea este c√≥digo con tu app:</h4>
          <img [src]="mfaQRCode" alt="QR MFA" style="max-width: 200px; margin: 10px auto; display: block;" />
          <button class="btn btn-light" (click)="cancelarMFA()">Cerrar</button>
        </div>
      </div>

      <!-- ACCIONES -->
      <div class="card">
        <div class="card-header">
          <mat-icon class="icon">settings</mat-icon>
          <h3>Acciones</h3>
        </div>

        <div class="actions-list">
          <button class="btn btn-primary" (click)="showPasswordForm = true">
            <mat-icon>lock_reset</mat-icon> Cambiar Contrase√±a
          </button>
  
                <!-- Bot√≥n para mostrar/ocultar historial de compras -->
            <button class="btn btn-light" (click)="mostrarCompras = !mostrarCompras">
            <mat-icon>shopping_cart_checkout</mat-icon>
            {{ mostrarCompras ? 'Ocultar Compras' : 'Ver Compras' }}
            </button>
        </div>
      </div>

      <!-- ESTADO DE LA CUENTA -->
      <div class="card status-card">
        <h3>Estado de la Cuenta</h3>
        <div class="status-indicator">
          <div class="status-dot"></div>
          <span>Cuenta Verificada</span>
        </div>
        <p>Tu cuenta est√° completamente verificada y segura</p>
      </div>
    </div>
  </div>
</div>

<p-dialog header="Cambiar Contrase√±a" [(visible)]="showPasswordForm" modal [closable]="false" [style]="{width: '400px'}">
  <form>
    <!-- Contrase√±a actual -->
    <div class="form-group" style="margin-bottom: 1.5rem;">
      <label for="currentPassword">Contrase√±a Actual</label>
      <p-password 
        id="currentPassword"
        name="currentPassword"
        [(ngModel)]="passwordData.currentPassword"
        required
        [toggleMask]="true"
        inputStyleClass="w-full"
        [feedback]="false"
      ></p-password>
    </div>

    <!-- Nueva contrase√±a -->
    <div class="form-group" style="margin-bottom: 1.5rem;">
      <label for="newPassword">Nueva Contrase√±a</label>
      <p-password 
        id="newPassword"
        name="newPassword"
        [(ngModel)]="passwordData.newPassword"
        required
        [toggleMask]="true"
        inputStyleClass="w-full"
        [feedback]="true"
        (input)="checkPasswordStrength(); validatePasswordsMatch()"
      ></p-password>
      <small [ngClass]="passwordStrength === 'Fuerte' ? 'text-success' : 'text-danger'">
        Fortaleza: {{ passwordStrength }}
      </small>
    </div>

    <!-- Confirmar nueva contrase√±a -->
    <div class="form-group" style="margin-bottom: 1.5rem;">
      <label for="confirmNewPassword">Confirmar Nueva Contrase√±a</label>
      <p-password 
        id="confirmNewPassword"
        name="confirmNewPassword"
        [(ngModel)]="passwordData.confirmNewPassword"
        required
        [toggleMask]="true"
        inputStyleClass="w-full"
        [feedback]="false"
        (input)="validatePasswordsMatch()"
      ></p-password>
      <small *ngIf="!passwordsMatch" class="text-danger">Las contrase√±as no coinciden</small>
    </div>

    <!-- Mensajes de error o √©xito -->
    <div *ngIf="errorMessage" class="alert alert-danger" role="alert" style="margin-top: 0.5rem;">
      {{ errorMessage }}
    </div>
    <div *ngIf="successMessage" class="alert alert-success" role="alert" style="margin-top: 0.5rem;">
      {{ successMessage }}
    </div>

    <!-- Botones -->
    <div class="form-actions" style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
<button
  type="button"
  class="btn btn-success"
  [disabled]="!isFormValid()"
  (click)="cambiarContrasena()"
>
  <mat-icon>save</mat-icon> Guardar
</button>

      <button class="btn btn-secondary" (click)="showPasswordForm = false">
        <mat-icon>cancel</mat-icon> Cancelar
      </button>
    </div>
  </form>
</p-dialog>



<!-- üü† TOAST DE MENSAJE -->
<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>



<div *ngIf="mostrarCompras" class="card historial-compras">
  <div class="card-header">
    <mat-icon class="icon">shopping_bag</mat-icon>
    <h3>Historial de Compras</h3>
  </div>

  <div *ngIf="ventas.length === 0" class="sin-compras">
    <p>No tienes compras registradas.</p>
  </div>

  <div class="compras-grid" *ngIf="ventas.length > 0">
    <div class="compra-item" *ngFor="let venta of ventas">
      <div class="compra-info">
        <div class="compra-header">
          <span class="compra-id">#{{ venta.id }}</span>
          <span class="compra-fecha">{{ venta.fecha | date: 'short' }}</span>
        </div>

        <div class="compra-detalles">
          <p><strong>Total:</strong> ${{ venta.total | number:'1.2-2' }}</p>
          <p><strong>M√©todo:</strong> {{ venta.metodo_pago }}</p>
          <p>
            <strong>Estado:</strong>
            <span  [ngClass]="venta.estado === 'completado' ? 'active' : 'inactive'">
              {{ venta.estado }}
            </span>
          </p>
          <p>
            <strong>Env√≠o:</strong>
            <span  [ngClass]="venta.estado_envio === 'Entregado' ? 'active' : 'inactive'">
              {{ venta.estado_envio }}
            </span>
          </p>
          <p><strong>Direcci√≥n:</strong> {{ venta.direccion_envio }}</p>
        </div>
      </div>

      <div class="compra-acciones">
        <button class="btn btn-light" (click)="verDetalle(venta.id)">
         Ver Detalle
        </button>
      </div>
    </div>
  </div>
</div>

  



<div class="toast success-toast" *ngIf="successMessage">{{ successMessage }}</div>
<div class="toast error-toast" *ngIf="errorMessage">{{ errorMessage }}</div>